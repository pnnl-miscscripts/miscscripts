---
# tasks file for TenantNamespace

- name: Set dryrun value
  ansible.builtin.set_fact:
    dryrun: "{{ lookup('env', 'DRYRUN') | default('False') | bool }}"

- name: Set admin labels
  ansible.builtin.set_fact:
    adminlabels: "{{ _miscscripts_pnnl_gov_tenantnamespace_spec.extraNamespaceLabels | default({}) | combine({'name': ansible_operator_meta.name + '-admin', 'miscscripts.pnnl.gov/namespace-type': 'admin'}, recursive=True) }}"

- name: Create the k8s admin namespace
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ ansible_operator_meta.name }}-admin"
        labels: "{{ adminlabels }}"
        annotations: "{{ _miscscripts_pnnl_gov_tenantnamespace_spec.extraNamespaceAnnotations | default({}) }}"
  check_mode: "{{ dryrun }}"

- name: Set initial defaults. They be overridden.
  ansible.builtin.set_fact:
    merged_values:
      magicnamespace:
        tiller:
          enabled: false
      gitlabRunner:
        autoSetNamespaceAndTags: true
        spec:
          runners: {}
      ingress:
        nginx:
          enabled: true

- name: Load in Flavor values if referenced
  when:
    - flavor_ref is defined
    - flavor_ref.kind == "TenantNamespaceFlavor"
    - flavor_ref.group == "miscscripts.pnnl.gov"
  block:
    - name: Fetch referenced flavor
      kubernetes.core.k8s_info:
        api_version: miscscripts.pnnl.gov/v1beta1
        kind: TenantNamespaceFlavor
        name: "{{ flavor_ref.name }}"
      register: flavor
      # Failures immediately trigger another reconciliation
      failed_when:
        - flavor.resources | length == 0
    - name: Merge in flavor values
      ansible.builtin.set_fact:
        merged_values: "{{ merged_values | combine(flavor.resources[0].spec, recursive=True) }}"
- name: Set values from CR
  ansible.builtin.set_fact:
    merged_values: "{{ merged_values | combine(_miscscripts_pnnl_gov_tenantnamespace_spec, recursive=True) }}"

- name: Setup gitlabRunner if needed
  ansible.builtin.set_fact:
    gitlabrunnerconfig:
      gitlabRunner:
        spec:
          runners:
            namespace: "{{ ansible_operator_meta.name }}"
            tags: "{{ (merged_values.gitlabRunner.spec.runners.tags.split(',') + [ansible_operator_meta.name]) | unique | list | join(',') }}"
  when:
    - merged_values.gitlabRunner.spec.runners.tags is defined
- name: Setup gitlabRunner if needed
  ansible.builtin.set_fact:
    gitlabrunnerconfig:
      gitlabRunner:
        spec:
          runners:
            namespace: "{{ ansible_operator_meta.name }}"
            tags: "{{ ansible_operator_meta.name }}"
  when:
    - merged_values.gitlabRunner.spec.runners.tags is not defined

- name: Merge gitlabRunner values
  ansible.builtin.set_fact:
    merged_values: "{{ merged_values | combine(gitlabrunnerconfig, recursive=True) }}"
  when:
    - merged_values.gitlabRunner.autoSetNamespaceAndTags

- name: Set value for forced settings
  ansible.builtin.set_fact:
    overrides:
      namespace: "{{ ansible_operator_meta.name }}"
      magicnamespace:
        namespace: "{{ ansible_operator_meta.name }}"
      ingress:
        nginx:
          clusterRole: "{{ lookup('env', 'INGRESS_CLUSTERROLE') | default('tenant-namespace-operator-ingress-controller') }}"
        controller:
          scope:
            namespace: "{{ ansible_operator_meta.name }}"

- name: Force namespace settings. Can not be overridden.
  ansible.builtin.set_fact:
    merged_values: "{{ merged_values | combine(overrides, recursive=True) }}"

- name: Set ingress ip if known
  ansible.builtin.set_fact:
    loadBalancerIP: "{{ _miscscripts_pnnl_gov_tenantnamespace.status.loadBalancerIP }}"
  when:
    - _miscscripts_pnnl_gov_tenantnamespace.status.loadBalancerIP is defined

- name: Fetch ingress service
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Service
    name: "{{ ansible_operator_meta.name }}-ingress-controller"
    namespace: "{{ ansible_operator_meta.name }}-admin"
  register: ingressService
  when: >
        merged_values.ingress.nginx.enabled and
        _miscscripts_pnnl_gov_tenantnamespace.status.loadBalancerIP is not defined

- name: Merge in existing ingress ip if exists
  when:
    - _miscscripts_pnnl_gov_tenantnamespace.status.loadBalancerIP is not defined
    - merged_values.ingress.controller.service.loadBalancerIP is not defined
    - ingressService is defined
    - ingressService.resources is defined
    - ingressService.resources[0] is defined
    - ingressService.resources[0].status is defined
    - ingressService.resources[0].status.loadBalancer is defined
    - ingressService.resources[0].status.loadBalancer.ingress is defined
    - ingressService.resources[0].status.loadBalancer.ingress[0] is defined
    - ingressService.resources[0].status.loadBalancer.ingress[0].ip is defined
  block:
    - name: Set ingress ip.
      ansible.builtin.set_fact:
        loadBalancerIP: "{{ ingressService.resources[0].status.loadBalancer.ingress[0].ip }}"
    - name: Set ingress ip in CR status
      operator_sdk.util.k8s_status:
        api_version: miscscripts.pnnl.gov/v1beta1
        kind: TenantNamespace
        name: "{{ ansible_operator_meta.name }}"
        namespace: "{{ ansible_operator_meta.namespace }}"
        status:
          loadBalancerIP: "{{ ingressService.resources[0].status.loadBalancer.ingress[0].ip }}"

- name: Set ingress ip if specified
  ansible.builtin.set_fact:
    loadBalancerIP: "{{ _miscscripts_pnnl_gov_tenantnamespace.spec.ingress.controller.service.loadBalancerIP }}"
  when:
    - loadBalancerIP is not defined
    - _miscscripts_pnnl_gov_tenantnamespace.spec.ingress is defined
    - _miscscripts_pnnl_gov_tenantnamespace.spec.ingress.controller is defined
    - _miscscripts_pnnl_gov_tenantnamespace.spec.ingress.controller.service is defined
    - _miscscripts_pnnl_gov_tenantnamespace.spec.ingress.controller.service.loadBalancerIP is defined

- name: Force loadBalancerIP address setting
  ansible.builtin.set_fact:
    loadBalancerIP_overrides:
      ingress:
        controller:
          service:
            loadBalancerIP: "{{ loadBalancerIP }}"
  when:
    - loadBalancerIP is defined
- name: Force loadBalancerIP. Can not be overridden.
  ansible.builtin.set_fact:
    merged_values: "{{ merged_values | combine(loadBalancerIP_overrides, recursive=True) }}"
  when:
    - loadBalancerIP is defined

# FIXME Consider making a service account specifically for this so it can't cross namespaces as far as it can today
- name: Run Helm
  kubernetes.core.helm:
    name: "{{ ansible_operator_meta.name }}"
    namespace: "{{ ansible_operator_meta.name }}-admin"
    chart_ref: ${HOME}/tenant-namespace
    values: "{{ merged_values }}"
  register: objs
  check_mode: "{{ dryrun }}"
  diff: "{{ dryrun }}"

- name: Set diff output on status
  operator_sdk.util.k8s_status:
    api_version: miscscripts.pnnl.gov/v1beta1
    kind: TenantNamespace
    name: "{{ ansible_operator_meta.name }}"
    namespace: "{{ ansible_operator_meta.namespace }}"
    status:
      diff: "{{ ((objs.diff.prepared | default('')) + '\n') | b64encode }}"

- name: Set user labels
  ansible.builtin.set_fact:
    userlabels: "{{ _miscscripts_pnnl_gov_tenantnamespace_spec.extraNamespaceLabels | default({}) | combine({'name': ansible_operator_meta.name, 'miscscripts.pnnl.gov/namespace-type': 'user'}, recursive=True) }}"

- name: Create the k8s user namespace
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ ansible_operator_meta.name }}"
        labels: "{{ userlabels }}"
        annotations: "{{ _miscscripts_pnnl_gov_tenantnamespace_spec.extraNamespaceAnnotations | default({}) }}"
  check_mode: "{{ dryrun }}"
